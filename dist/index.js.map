{"version":3,"sources":["../src/index.js"],"names":["require","config","main","createPrivacyPolicy","insertTestData","console","time","Models","App","findOne","app","User","user","userId","id","toString","hashValue","privacyPreference","EvaluateHash","hash","createdAt","$gte","utc","subtract","Number","timeofRetention","permission","log","result","Helpers","PrivacyPreference","evaluate","isAccepted","create","timeEnd","PrivacyPolicy","hasData","insertMany","attributes","name","left","right","purposes","deleteMany","privacyPolicy","Moverment","find","item","Height","TPostal","TEMail","exceptions","denyAttributes","allowedPurposes","prohibitedPurposes","denyPurposes"],"mappings":"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","sourcesContent":["require(\"dotenv\").config();\nimport \"./services/mongoose\";\nimport Models from \"./models\";\nimport Helpers from \"./helpers\";\nimport { computeCacheKey } from \"./utils/hashUtils.js\";\nimport moment from \"moment\";\n\nmain();\nasync function main() {\n  // create privacy policy\n  await createPrivacyPolicy();\n  // data test\n  await insertTestData();\n  // return; // xoa khi chay xong 2 function tren\n  console.time(\"running time\");\n  const app = await Models.App.findOne();\n  const user = await Models.User.findOne();\n  const userId = user.id.toString();\n  // // check hash (using SHA-256)\n  const hashValue = computeCacheKey(app, user.privacyPreference);\n\n  const permission = await Models.EvaluateHash.findOne({\n    userId,\n    hash: hashValue,\n    createdAt: {\n      $gte: moment()\n        .utc()\n        .subtract(Number(user.privacyPreference.timeofRetention), \"second\"),\n    },\n  });\n\n  if (permission) {\n    console.log(\"OK\" + permission.result);\n  } else {\n    const isAccepted = await Helpers.PrivacyPreference.evaluate(app, user);\n\n    if (isAccepted) {\n      console.log(\"OK Accepted\");\n    } else {\n      console.log(\"NO Accepted\");\n    }\n    await Models.EvaluateHash.create({\n      userId,\n      hash: hashValue,\n      result: isAccepted ? \"grant\" : \" deny\",\n    });\n  }\n\n  console.timeEnd(\"running time\");\n}\n\nasync function createPrivacyPolicy() {\n  const hasData = await Models.PrivacyPolicy.findOne({});\n  if (hasData) return;\n\n  await Models.PrivacyPolicy.insertMany([\n    {\n      attributes: [\n        { name: \"General\", left: 1, right: 31 },\n\n        { name: \"Identifier\", left: 2, right: 7 },\n        { name: \"UserId\", left: 3, right: 4 },\n        { name: \"Name\", left: 5, right: 6 },\n\n        { name: \"Generic\", left: 7, right: 16 },\n        { name: \"Fitness\", left: 8, right: 15 },\n        { name: \"Moverment\", left: 9, right: 10 },\n        { name: \"Height\", left: 11, right: 12 },\n        { name: \"Weight\", left: 13, right: 14 },\n\n        { name: \"Sensitive\", left: 17, right: 30 },\n        { name: \"Position\", left: 18, right: 19 },\n        { name: \"Health\", left: 20, right: 29 },\n        { name: \"Physical state\", left: 21, right: 26 },\n        { name: \"Heart rate\", left: 22, right: 23 },\n        { name: \"Blood pressure\", left: 24, right: 25 },\n        { name: \"Psychological state\", left: 27, right: 28 },\n      ],\n      purposes: [\n        { name: \"General\", left: 1, right: 32 },\n\n        { name: \"Admin\", left: 2, right: 7 },\n        { name: \"Profilling\", left: 3, right: 4 },\n        { name: \"Analysis\", left: 5, right: 6 },\n\n        { name: \"Purchase\", left: 8, right: 9 },\n\n        { name: \"Shipping\", left: 10, right: 11 },\n\n        { name: \"Maketing\", left: 12, right: 31 },\n\n        { name: \"Direct\", left: 13, right: 24 },\n        { name: \"DPhone\", left: 14, right: 15 },\n        { name: \"DEmail\", left: 16, right: 21 },\n        { name: \"Service updates\", left: 17, right: 18 },\n        { name: \"Special offers\", left: 19, right: 20 },\n        { name: \"DFax\", left: 22, right: 23 },\n\n        { name: \"Third-party\", left: 24, right: 30 },\n        { name: \"TEMail\", left: 26, right: 27 },\n        { name: \"TPostal\", left: 28, right: 29 },\n      ],\n    },\n  ]);\n}\nasync function insertTestData() {\n  await Models.EvaluateHash.deleteMany({});\n  await Models.User.deleteMany({});\n  await Models.App.deleteMany({});\n\n  const privacyPolicy = await Models.PrivacyPolicy.findOne({});\n\n  const Moverment = privacyPolicy.attributes.find(\n    (item) => item.name === \"Moverment\"\n  );\n  const Height = privacyPolicy.attributes.find(\n    (item) => item.name === \"Height\"\n  );\n\n  const TPostal = privacyPolicy.purposes.find(\n    (item) => item.name === \"TPostal\"\n  );\n  const TEMail = privacyPolicy.purposes.find((item) => item.name === \"TEMail\");\n  await Models.User.create({\n    privacyPreference: {\n      attributes: [Moverment.id], // Moverment\n      exceptions: [Height.id], // Height\n      denyAttributes: [Height.id], // Height\n\n      allowedPurposes: [TPostal.id], // TPostal\n      prohibitedPurposes: [TEMail.id], // TEMail\n      denyPurposes: [TEMail.id], // TEMail\n      timeofRetention: 1000, // second\n    },\n  });\n\n  await Models.App.create({\n    name: \"App 1\",\n    attributes: [Moverment.id], // Moverment\n    purposes: [TPostal.id], // TPostal,\n    timeofRetention: 500,\n  });\n}\n"],"file":"index.js"}